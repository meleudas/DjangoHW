<!-- templates/discounts/promo_apply_block.html -->
<div class="bg-gray-50 rounded-lg p-4 mb-4">
  <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
    <i class="fas fa-gift text-purple-500 mr-2"></i> Промокод
  </h3>

  {% if promo_info %}
    <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-3">
      <div class="flex justify-between items-center">
        <span class="text-green-800 font-medium">
          <i class="fas fa-check-circle mr-1"></i> {{ promo_info.promo.code }}
        </span>
        <form method="post" action="{% url 'discounts:remove_promo_code' %}" class="inline" style="display:inline;">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <button type="submit" class="text-xs text-red-600 hover:text-red-800 font-medium">
            <i class="fas fa-times-circle mr-1"></i> Скасувати
          </button>
        </form>
      </div>
      <p class="text-sm text-green-700 mt-1">{{ promo_info.note }}</p>
    </div>
  {% endif %}

  {% if user.is_authenticated %}
    <form id="promo-apply-form" class="flex gap-2">
      {% csrf_token %}
      <input type="text" name="promo_code"
             class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
             placeholder="Введіть код...">
      <button type="submit" 
              class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium">
        Застосувати
      </button>
    </form>
    
    <div id="promo-response" class="mt-2 text-sm hidden"></div>

    <script>
      document.getElementById('promo-apply-form').addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        // ⚠️ ВАЖЛИВО: передаємо поточну суму кошика
        const orderAmount = {{ cart.get_total_price|floatformat:2 }};
        formData.append('order_amount', orderAmount);

        const response = await fetch('{% url "discounts:apply_promo_code" %}', {
          method: 'POST',
          headers: {'X-CSRFToken': '{{ csrf_token }}'},
          body: formData
        });
        const data = await response.json();

        const el = document.getElementById('promo-response');
        el.classList.remove('hidden');
        if (data.success) {
          el.classList.remove('text-red-600');
          el.classList.add('text-green-700');
          el.innerHTML = `✅ ${data.note}. Зекономлено: ₴${data.discount_amount}`;
          setTimeout(() => location.reload(), 1200);
        } else {
          el.classList.remove('text-green-700');
          el.classList.add('text-red-600');
          el.innerHTML = `❌ ${typeof data.error === 'string' ? data.error : Object.values(data.error)[0]}`;
        }
      });
    </script>

  {% else %}
    <p class="text-sm text-gray-600">
      <i class="fas fa-info-circle mr-1 text-blue-500"></i>
      Увійдіть, щоб використовувати промокоди.
    </p>
  {% endif %}
</div>